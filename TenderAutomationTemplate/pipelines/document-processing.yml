# üìÑ Pipeline: Document Processing
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ç–µ–Ω–¥–µ—Ä–æ–≤

name: "document-processing"
version: "1.0"
description: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ç–µ–Ω–¥–µ—Ä–æ–≤ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤"

# ‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
schedule:
  interval: "30m"          # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  timezone: "Europe/Moscow"
  enabled: true

# üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
config:
  # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  supported_formats:
    - "pdf"
    - "doc"
    - "docx"
    - "xlsx"
    - "xls"
    - "rtf"
    - "txt"
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
  download:
    max_file_size: "50MB"
    timeout: "300s"
    concurrent_downloads: 5
    retry_count: 3
    
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  processing:
    max_processing_time: "10m"
    temp_directory: "/tmp/tender_docs"
    preserve_original: true
    generate_thumbnails: false

# üîÑ –≠—Ç–∞–ø—ã –ø–∞–π–ø–ª–∞–π–Ω–∞
stages:
  # –≠–¢–ê–ü 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - name: "document_discovery"
    type: "sequential"
    timeout: "5m"
    
    steps:
      - name: "fetch_pending_tenders"
        type: "database_query"
        description: "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–æ–≤ —Å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏"
        query: |
          SELECT t.id, t.title, t.documents_url, t.platform
          FROM tenders t 
          WHERE t.status = 'documents_pending' 
          AND t.ai_relevance_score >= 0.7
          ORDER BY t.created_at DESC
          LIMIT 100
          
      - name: "prioritize_documents"
        type: "sorter"
        description: "–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–¥–ª–∞–π–Ω–∞–º"
        criteria:
          - "deadline_proximity"
          - "ai_relevance_score"
          - "budget_amount"

  # –≠–¢–ê–ü 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - name: "document_download"
    type: "parallel"
    timeout: "20m"
    batch_size: 3
    
    steps:
      - name: "download_files"
        type: "downloader"
        config:
          user_agent: "TenderBot Document Processor/1.0"
          headers:
            Accept: "application/pdf,application/msword,application/vnd.openxmlformats-officedocument.*"
          follow_redirects: true
          verify_ssl: true
          
      - name: "virus_scan"
        type: "security_scanner"
        description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –≤–∏—Ä—É—Å—ã"
        config:
          engine: "clamav"
          quarantine_suspicious: true
          
      - name: "format_validation"
        type: "validator"
        description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤"

  # –≠–¢–ê–ü 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
  - name: "text_extraction"
    type: "parallel"
    timeout: "15m"
    
    steps:
      - name: "extract_pdf"
        type: "text_extractor"
        condition: "file_type == 'pdf'"
        config:
          engine: "pdfplumber"
          preserve_layout: true
          extract_tables: true
          ocr_fallback: true
          
      - name: "extract_office"
        type: "text_extractor"
        condition: "file_type in ['doc', 'docx', 'rtf']"
        config:
          engine: "unioffice"
          preserve_formatting: true
          extract_tables: true
          
      - name: "extract_excel"
        type: "text_extractor"
        condition: "file_type in ['xls', 'xlsx']"
        config:
          engine: "excelize"
          extract_all_sheets: true
          preserve_formulas: false

  # –≠–¢–ê–ü 4: –ü–æ–∏—Å–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
  - name: "technical_task_identification"
    type: "sequential"
    timeout: "10m"
    
    steps:
      - name: "content_analysis"
        type: "ai_processor"
        model: "llama4-maviric"
        config:
          prompt_template: "technical_task_identification"
          max_tokens: 2000
          
      - name: "keyword_matching"
        type: "keyword_matcher"
        keywords:
          technical_task_indicators:
            - "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ"
            - "—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è"
            - "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–æ–≤–∞—Ä—É"
            - "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
            - "–ø–µ—Ä–µ—á–µ–Ω—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
          
      - name: "table_detection"
        type: "table_detector"
        description: "–ü–æ–∏—Å–∫ —Ç–∞–±–ª–∏—Ü —Å —Ç–æ–≤–∞—Ä–∞–º–∏"

  # –≠–¢–ê–ü 5: AI –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
  - name: "product_extraction"
    type: "sequential"
    timeout: "20m"
    
    steps:
      - name: "ai_product_analysis"
        type: "ai_processor"
        model: "llama4-maviric"
        config:
          prompt_template: "product_extraction"
          max_tokens: 4000
          temperature: 0.1
          extract_schema:
            products:
              - name: "string"
                category: "string"
                specifications: "object"
                quantity: "integer"
                unit: "string"
                max_price: "float"
                requirements: "array"
                
      - name: "data_validation"
        type: "validator"
        description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
        validation_rules:
          - "product_name_not_empty"
          - "quantity_is_positive"
          - "price_is_reasonable"
          
      - name: "category_classification"
        type: "ai_processor"
        model: "llama4-maviric"
        config:
          prompt_template: "equipment_categorization"
          categories:
            - "–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
            - "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
            - "–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
            - "–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
            - "–†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
            - "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏"
            - "–ú–µ–±–µ–ª—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è"

  # –≠–¢–ê–ü 6: –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  - name: "data_enrichment"
    type: "parallel"
    timeout: "10m"
    
    steps:
      - name: "specifications_parsing"
        type: "ai_processor"
        description: "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫"
        
      - name: "compliance_check"
        type: "compliance_checker"
        description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º"
        standards:
          - "–ì–û–°–¢ –† –ò–°–û 13485"
          - "–ì–û–°–¢ –† 50444"
          - "–¢–† –¢–° 021/2011"
          
      - name: "generate_search_terms"
        type: "ai_processor"
        description: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤"

  # –≠–¢–ê–ü 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  - name: "persistence"
    type: "sequential"
    timeout: "5m"
    
    steps:
      - name: "save_products"
        type: "database"
        description: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"
        
      - name: "update_tender_status"
        type: "database"
        description: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ–Ω–¥–µ—Ä–∞"
        
      - name: "index_for_search"
        type: "search_indexer"
        description: "–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞"
        
      - name: "emit_events"
        type: "event_emitter"
        events:
          - "products_extracted"
          - "tender_ready_for_supplier_search"

# üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
monitoring:
  metrics:
    - name: "documents_processed"
      type: "counter"
      
    - name: "products_extracted"
      type: "counter"
      
    - name: "extraction_accuracy"
      type: "gauge"
      
    - name: "processing_time_per_document"
      type: "histogram"

  alerts:
    - name: "low_extraction_accuracy"
      condition: "extraction_accuracy < 80%"
      severity: "warning"
      
    - name: "processing_timeout"
      condition: "processing_time > 30m"
      severity: "critical"

# üß™ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
quality_assurance:
  sampling_rate: 0.1        # 10% –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
  
  quality_metrics:
    - name: "product_name_accuracy"
      target: 95
      
    - name: "specification_completeness"
      target: 85
      
    - name: "price_extraction_accuracy"
      target: 90

# üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
expected_results:
  documents_per_run: 20-50
  products_per_document: 5-25
  processing_time_per_doc: 2-8  # –º–∏–Ω—É—Ç
  extraction_accuracy: 85-95    # –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤